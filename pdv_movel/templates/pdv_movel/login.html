{% extends "pdv_movel/base.html" %}
{% load static %}

{% block title %}Login - PDV M√≥vel{% endblock %}

{% block content %}
<div class="login-container">
    <div class="login-card">
        <div class="login-logo">
            <h1>üéÜ</h1>
            <h2>Guardi√£o Aladin</h2>
            <p>PDV M√≥vel</p>
        </div>
        <form method="post" action="" id="form-login">
            {% csrf_token %}
            <p class="login-label">Digite seu PIN de atendente:</p>
            <input type="hidden" name="pin" id="pin-input" value="">
            <div class="pin-display">
                <span class="pin-dot" data-dot="0"></span>
                <span class="pin-dot" data-dot="1"></span>
                <span class="pin-dot" data-dot="2"></span>
                <span class="pin-dot" data-dot="3"></span>
            </div>
            <div class="keyboard">
                <button type="button" class="key" data-key="1">1</button>
                <button type="button" class="key" data-key="2">2</button>
                <button type="button" class="key" data-key="3">3</button>
                <button type="button" class="key" data-key="4">4</button>
                <button type="button" class="key" data-key="5">5</button>
                <button type="button" class="key" data-key="6">6</button>
                <button type="button" class="key" data-key="7">7</button>
                <button type="button" class="key" data-key="8">8</button>
                <button type="button" class="key" data-key="9">9</button>
                <button type="button" class="key key-back" data-key="back">‚Üê</button>
                <button type="button" class="key" data-key="0">0</button>
                <button type="button" class="key key-ok" data-key="ok">‚úì</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    var pinValue = '';
    var pinDots = document.querySelectorAll('.pin-dot');
    var pinInput = document.getElementById('pin-input');
    var form = document.getElementById('form-login');

    function updatePinDisplay() {
        pinDots.forEach(function(dot, i) {
            if (i < pinValue.length) dot.classList.add('filled');
            else dot.classList.remove('filled');
        });
    }

    function showToast(msg, type) {
        if (typeof window.showToast === 'function') window.showToast(msg, type);
        else alert(msg);
    }

    document.querySelectorAll('.key').forEach(function(key) {
        key.addEventListener('click', function(e) {
            e.preventDefault();
            var v = this.getAttribute('data-key');
            if (v === 'back') {
                pinValue = pinValue.slice(0, -1);
            } else if (v === 'ok') {
                if (pinValue.length === 4) {
                    pinInput.value = pinValue;
                    form.submit();
                } else {
                    showToast('Digite os 4 d√≠gitos do PIN', 'warning');
                }
                return;
            } else {
                if (pinValue.length < 4) pinValue += v;
            }
            updatePinDisplay();
            if (pinValue.length === 4) {
                setTimeout(function() {
                    pinInput.value = pinValue;
                    form.submit();
                }, 300);
            }
        });
    });

    document.addEventListener('keydown', function(e) {
        if (e.key >= '0' && e.key <= '9') {
            if (pinValue.length < 4) {
                pinValue += e.key;
                updatePinDisplay();
                if (pinValue.length === 4) {
                    setTimeout(function() { pinInput.value = pinValue; form.submit(); }, 300);
                }
            }
        } else if (e.key === 'Backspace') {
            pinValue = pinValue.slice(0, -1);
            updatePinDisplay();
        } else if (e.key === 'Enter' && pinValue.length === 4) {
            pinInput.value = pinValue;
            form.submit();
        }
    });
})();
</script>
{% endblock %}
