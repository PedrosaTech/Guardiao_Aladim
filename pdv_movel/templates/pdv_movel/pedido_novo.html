{% extends "pdv_movel/base.html" %}
{% load static %}

{% block title %}Novo Pedido - PDV M√≥vel{% endblock %}

{% block content %}
<div class="search-bar">
    <div class="search-container">
        <input type="search" id="search-input" class="input input-search" placeholder="Buscar produto..." autocomplete="off">
        <button type="button" class="btn-camera" onclick="abrirCamera()">üì∑ Scan</button>
    </div>
</div>

<div id="mais-vendidos-container" class="card">
    <div class="card-header">‚ö° Mais Vendidos</div>
    <div id="mais-vendidos-grid" class="produtos-grid"></div>
</div>

<div id="produtos-container" class="produtos-grid" style="display: none;"></div>

<div class="card">
    <div class="card-header">üõí Pedido Atual <span id="pedido-numero">#----</span></div>
    <div id="itens-container" class="itens-container">
        <div class="empty-state">
            <div class="empty-state-icon">üõçÔ∏è</div>
            <div class="empty-state-text">Nenhum item adicionado</div>
        </div>
    </div>
    <div class="totais-container">
        <div class="total-row"><span>Subtotal:</span><span id="subtotal">R$ 0,00</span></div>
        <div class="total-row"><span>Desconto:</span><span id="desconto">R$ 0,00</span></div>
        <div class="total-row total-final"><span>TOTAL:</span><span id="total">R$ 0,00</span></div>
    </div>
</div>

<div class="floating-actions">
    <button type="button" class="btn btn-secondary" onclick="limparPedido()">üóëÔ∏è Limpar</button>
    <button type="button" class="btn btn-success btn-lg" id="btn-salvar" onclick="abrirModalEnviarCaixa()" disabled>
        ‚úì Salvar e Enviar para Caixa
    </button>
</div>

<div id="modal-enviar-caixa" class="modal-enviar-caixa" style="display: none;">
    <div class="modal-enviar-caixa-content">
        <h3>üì± Enviar para o Caixa</h3>
        <p class="modal-enviar-caixa-total">Total: <strong id="modal-enviar-total">R$ 0,00</strong></p>
        <p class="modal-enviar-caixa-dica">Cliente j√° sabe como vai pagar? (opcional)</p>
        <select id="modal-enviar-forma" class="modal-enviar-forma">
            <option value="NAO_INFORMADO">‚ùì N√£o informado (vai decidir no caixa)</option>
            <option value="DINHEIRO">üíµ Dinheiro</option>
            <option value="CARTAO_DEBITO">üí≥ Cart√£o D√©bito</option>
            <option value="CARTAO_CREDITO">üí≥ Cart√£o Cr√©dito</option>
            <option value="PIX">üì± PIX</option>
        </select>
        <div class="modal-enviar-caixa-actions">
            <button type="button" class="btn btn-secondary" id="modal-enviar-cancelar">Voltar</button>
            <button type="button" class="btn btn-success" id="modal-enviar-confirmar">Enviar para o Caixa</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .modal-enviar-caixa { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .modal-enviar-caixa-content { background: #1a1a2e; padding: 24px; border-radius: 12px; max-width: 360px; width: 90%; border: 2px solid #667eea; }
    .modal-enviar-caixa-content h3 { margin: 0 0 16px; font-size: 1.25rem; }
    .modal-enviar-caixa-total { margin: 0 0 16px; font-size: 1.1rem; }
    .modal-enviar-caixa-dica { margin: 0 0 8px; color: #aaa; font-size: 0.9rem; }
    .modal-enviar-forma { width: 100%; padding: 10px 12px; margin-bottom: 20px; border-radius: 8px; border: 2px solid #667eea; background: #16213e; color: #fff; font-size: 1rem; }
    .modal-enviar-caixa-actions { display: flex; gap: 10px; }
    .modal-enviar-caixa-actions .btn { flex: 1; }
</style>
{% endblock %}
{% block extra_js %}
<script src="{% static 'pdv_movel/js/pedido.js' %}"></script>
<script src="{% static 'pdv_movel/js/produtos.js' %}"></script>
<script>
(function() {
    var searchInput = document.getElementById('search-input');
    var searchFn = debounce(function(e) {
        var q = (e && e.target ? e.target.value : '').trim();
        if (q.length >= 2) buscarProdutos(q);
        else {
            document.getElementById('produtos-container').style.display = 'none';
            document.getElementById('mais-vendidos-container').style.display = 'block';
        }
    }, 300);

    document.addEventListener('DOMContentLoaded', function() {
        if (searchInput) searchInput.addEventListener('input', searchFn);
        carregarMaisVendidos().then(function() {
            return iniciarNovoPedido();
        }).then(function() {
            hideLoading();
        }).catch(function(err) {
            hideLoading();
            if (typeof showToast === 'function') showToast('Erro ao carregar: ' + (err && err.message ? err.message : 'Erro'), 'error');
        });
        showLoading('Carregando...');
    });
})();
</script>
{% endblock %}
